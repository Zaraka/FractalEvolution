/*! fracgen 2017-04-11 */

function Chromosone(){if(1!==arguments.length)throw new SyntaxError("Chromosone invalid arguments","chromosone.js");if(void 0===arguments[0])throw new TypeError("Chromosone undefined input","chromosone.js");if("Chromosone"===arguments[0].constructor.name){var a=arguments[0];this.iterationMax=a.iterationMax,this.zoom=a.zoom,this.moveX=a.moveX,this.moveY=a.moveY,void 0!==a.cRe&&(this.cRe=a.cRe),void 0!==a.cIm&&(this.cIm=a.cIm),void 0!==a.exp&&(this.exp=a.exp),void 0===a.a?(this.redStart=a.redStart,this.greenStart=a.greenStart,this.blueStart=a.blueStart,this.redSpeed=a.redSpeed,this.greenSpeed=a.greenSpeed,this.blueSpeed=a.blueSpeed):(this.a=new Vec3(a.a),this.b=new Vec3(a.b),this.c=new Vec3(a.c),this.d=new Vec3(a.d))}else{var b=arguments[0];this.iterationMax=generateValue(null,b.structure.iterationMax,b.fractal),this.zoom=generateValue(null,b.structure.zoom,b.fractal),this.moveX=generateValue(null,b.structure.moveX,b.fractal),this.moveY=generateValue(null,b.structure.moveY,b.fractal),"glynn_all"!==b.fractal&&"julia_quadratic"!==b.fractal||(this.cRe=generateValue(null,b.structure.cRe,b.fractal),"julia_quadratic"===b.fractal?this.cIm=generateValue(null,b.structure.cIm,b.fractal):this.exp=generateValue(null,b.structure.exp,b.fractal)),"pallete"===b.color?(this.a=generateValue(null,b.structure.a,b.fractal),this.b=generateValue(null,b.structure.b,b.fractal),this.c=generateValue(null,b.structure.c,b.fractal),this.d=generateValue(null,b.structure.d,b.fractal)):(this.redStart=generateValue(null,b.structure.redStart,b.fractal),this.greenStart=generateValue(null,b.structure.greenStart,b.fractal),this.blueStart=generateValue(null,b.structure.blueStart,b.fractal),this.redSpeed=generateValue(null,b.structure.redSpeed,b.fractal),this.greenSpeed=generateValue(null,b.structure.greenSpeed,b.fractal),this.blueSpeed=generateValue(null,b.structure.blueSpeed,b.fractal))}}function generateValue(a,b,c){if("vec3"===b.type)return new Vec3;var d=0,e=b.limit[c].min,f=Math.abs(b.limit[c].min)+Math.abs(b.limit[c].max),g=e+f;if("random"===b.method||null===a)d="random"===b.method&&"exp"===b.distribution?randomExp(e,g):random(e,g);else do{d=a+Math.random()*f*random(-b.intensity,b.intensity)}while(d<b.limit[c].min||d>b.limit[c].max);return"integer"===b.type&&(d=Math.round(d)),d}function equalChromosones(a,b,c){if(a.iterationMax!==b.iterationMax||a.zoom!==b.zoom||a.moveX!==b.moveX||a.moveY!==b.moveY)return!1;if("julia_quadratic"===c.fractal){if(a.cRe!==b.cRe||a.cIm!==b.cIm)return!1}else if("glynn_all"===c.fractal&&(a.cRe!==b.cRe||a.exp!==b.exp))return!1;return!!("pallete"!==c.color||a.a.equals(b.a)&&a.b.equals(b.b)&&a.c.equals(b.c)&&a.d.equals(b.d))&&(a.redStart===b.redStart&&a.greenStart===b.greenStart&&a.blueStart===b.blueStart&&a.redSpeed===b.redSpeed&&a.greenSpeed===b.greenSpeed&&a.blueSpeed===b.blueSpeed)}function random(a,b){return Math.random()*(b-a)+a}function randomExp(a,b){return Math.pow(Math.random(),2)*(b-a)+a}function Vec3(){var a=0,b=0,c=0;if(3==arguments.length)a=arguments[0],b=arguments[1],c=arguments[2];else if(1==arguments.length){var d=arguments[0];void 0!==d&&(a=d.x,b=d.y,c=d.z)}else a=Math.random(),b=Math.random(),c=Math.random();this.x=a,this.y=b,this.z=c}function pallete(a,b,c,d,e){if("number"!=typeof a&&"object"!=typeof b&&"object"!=typeof c&&"object"!=typeof d&&"object"!=typeof e)throw new TypeError("pallete wrong arguments","vector.js");return new Vec3(d).mul(a).add(e).mul(2*Math.PI).cos().mul(c).add(b).toRGB()}Chromosone.prototype.mutate=function(a){var b=a.structure;Math.random()<=b.iterationMax.chance&&(this.iterationMax=generateValue(this.iterationMax,b.iterationMax,a.fractal)),Math.random()<=b.zoom.chance&&(this.zoom=generateValue(this.zoom,b.zoom,a.fractal)),Math.random()<=b.moveX.chance&&(this.moveX=generateValue(this.moveX,b.moveX,a.fractal)),Math.random()<=b.moveY.chance&&(this.moveY=generateValue(this.moveY,b.moveY,a.fractal)),"glynn_all"!==a.fractal&&"julia_quadratic"!==a.fractal||(Math.random()<=b.cRe.chance&&(this.cRe=generateValue(this.cRe,b.cRe,a.fractal)),"julia_quadratic"===a.fractal?Math.random()<=b.cIm.chance&&(this.cIm=generateValue(this.cIm,b.cIm,a.fractal)):Math.random()<=b.exp.chance&&(this.exp=generateValue(this.exp,b.exp,a.fractal))),"pallete"===a.color?(Math.random()<=b.a.chance&&(this.a=new Vec3),Math.random()<=b.b.chance&&(this.b=new Vec3),Math.random()<=b.c.chance&&(this.c=new Vec3),Math.random()<=b.d.chance&&(this.d=new Vec3)):(Math.random()<=b.redStart.chance&&(this.redStart=generateValue(this.redStart,b.redStart,a.fractal)),Math.random()<=b.greenStart.chance&&(this.greenStart=generateValue(this.greenStart,b.greenStart,a.fractal)),Math.random()<=b.blueStart.chance&&(this.blueStart=generateValue(this.blueStart,b.blueStart,a.fractal)),Math.random()<=b.redSpeed.chance&&(this.redSpeed=generateValue(this.redSpeed,b.redSpeed,a.fractal)),Math.random()<=b.greenSpeed.chance&&(this.greenSpeed=generateValue(this.greenSpeed,b.greenSpeed,a.fractal)),Math.random()<=b.blueSpeed.chance&&(this.blueSpeed=generateValue(this.blueSpeed,b.blueSpeed,a.fractal)))},Vec3.prototype.sin=function(){return this.x=Math.sin(this.x),this.y=Math.sin(this.y),this.z=Math.sin(this.z),this},Vec3.prototype.cos=function(){return this.x=Math.cos(this.x),this.y=Math.cos(this.y),this.z=Math.cos(this.z),this},Vec3.prototype.add=function(a){return"number"==typeof a?(this.x+=a,this.y+=a,this.z+=a):(this.x+=a.x,this.y+=a.y,this.z+=a.z),this},Vec3.prototype.sub=function(a){return"number"==typeof a?(this.x+=-a,this.y+=-a,this.z+=-a):(this.x+=-a.x,this.y+=-a.y,this.z+=-a.z),this},Vec3.prototype.mul=function(a){return"number"==typeof a?(this.x*=a,this.y*=a,this.z*=a):(this.x*=a.x,this.y*=a.y,this.z*=a.z),this},Vec3.prototype.mod=function(a){return"number"==typeof a?(this.x%=a,this.y%=a,this.z%=a):(this.x%=a.x,this.y%=a.y,this.z%=a.z),this},Vec3.prototype.toRGB=function(){return this.x=Math.round(255*this.x),this.y=Math.round(255*this.y),this.z=Math.round(255*this.z),this},Vec3.prototype.equals=function(a){return"object"==typeof a&&(this===a||this.x==a.x&&this.y==a.y&&this.z==a.z)};var evo={canvas:[],generated:0,worker:[],palleter:[],entropy:[],selected:null,lock:!1,checkRequirements:function(){return"undefined"==typeof Storage?(alert("This browser doesn't support localstorage needed for application run."),!1):"undefined"!=typeof Worker||(alert("This browser doesn't support Web Worker needed for application run."),!1)},init:function(){if(!this.lock){this.lock=!0,this.ui.init();for(var a=0;a<9;a++)this.canvas[a]=document.getElementById(a.toString()),this.canvas[a].height=this.canvas[a].width/4*3,this.worker[a]=new Worker("assets/js/fractaler.js"),this.worker[a].onmessage=this.processWorkerMessage;this.palleter=new Worker("assets/js/palleter.js"),this.palleter.onmessage=function(a){var b=document.getElementById("details-pallete"),c=b.getContext("2d"),d=c.createImageData(b.width,b.height);d.data.set(a.data.imageData),c.putImageData(d,0,0)},this.lock=!1,this.generate(),this.hideSelect()}},generateNew:function(){this.lock?alert("Please wait until new fractals are generated before reseting."):(this.ui.resetIteration(),this.hideSelect(),this.generate())},generate:function(){if(!this.lock){this.lock=!0,$(".hiddable").addClass("hidden"),$("#"+this.selected).parent().addClass("locked"),this.generated=0,this.ui.updateCounter();for(var a=0;a<9;a++)a!=this.selected?this.generateFractal(a):(this.generated++,this.ui.updateCounter());this.settings.iteration++,this.ui.updateIterator()}},generateFractal:function(a){if(null===this.selected)this.settings.chromosone[a]=new Chromosone(this.settings);else{for(var b=new Chromosone(this.settings.chromosone[this.selected]);equalChromosones(this.settings.chromosone[this.selected],b,this.settings);)b.mutate(this.settings);this.settings.chromosone[a]=b}this.drawChromosone(a,null,null)},drawChromosone:function(a,b,c,d){d=void 0!==d&&d;var e=new Chromosone(this.settings.chromosone[a]);e.fractalId=d?"hd":a,e.width=null===b?this.canvas[a].width:b,e.height=null===c?this.canvas[a].height:c,e.fractal=this.settings.fractal,e.color=this.settings.color,e.start=new Vec3(e.redStart,e.greenStart,e.blueStart),e.speed=new Vec3(e.redSpeed,e.greenSpeed,e.blueSpeed),this.worker[d?0:a].postMessage(e)},drawCustomChromosone:function(a){evo.worker[0].postMessage(a)},select:function(a){if(!this.lock)if(a==this.selected)this.hideSelect();else{null!==this.selected&&$("#"+this.selected).parent().removeClass("active"),this.selected=a,$("#"+a).parent().addClass("active"),this.ui.details.empty();var b=$('<table style="margin: 0 auto;"></table>').appendTo(this.ui.details),c=this.settings.chromosone[this.selected];b.append("<tr><td class='table-label'>Iterations</td><td>"+c.iterationMax+"</td></tr>"),b.append("<tr><td class='table-label'>Zoom</td><td>"+c.zoom.toFixed(4)+"</td></tr>"),b.append("<tr><td class='table-label'>X</td><td>"+c.moveX.toFixed(4)+"</td></tr>"),b.append("<tr><td class='table-label'>Y</td><td>"+c.moveY.toFixed(4)+"</td></tr>"),void 0!==c.cRe&&b.append("<tr><td class='table-label'>cRe</td><td>"+c.cRe.toFixed(4)+"</td></tr>"),void 0!==c.cIm&&b.append("<tr><td class='table-label'>cIm</td><td>"+c.cIm.toFixed(4)+"</td></tr>"),void 0!==c.exp&&b.append("<tr><td class='table-label'>Exp</td><td>"+c.exp.toFixed(4)+"</td></tr>"),b.append("<tr><td class='table-label'>Pallete</td><td><canvas class='pallete' id='details-pallete'></canvas></td></tr>");var d,e=document.getElementById("details-pallete");d="pallete"===this.settings.color?{width:e.width,height:e.height,color:evo.settings.color,iterations:c.iterationMax,a:c.a,b:c.b,c:c.c,d:c.d}:{width:e.width,height:e.height,color:evo.settings.color,iterations:c.iterationMax,start:new Vec3(c.redStart,c.greenStart,c.blueStart),speed:new Vec3(c.redSpeed,c.greenSpeed,c.blueSpeed)},this.palleter.postMessage(d),b.append("<tr><td class='table-label'>Entropy</td><td>"+this.entropy[this.selected].toFixed(4)+"</td></tr>"),$(".hiddable").removeClass("hidden"),this.ui.command.innerHTML=""}},hideSelect:function(){null!==this.selected&&$("#"+this.selected).parent().removeClass("active"),$(".hiddable").addClass("hidden"),this.ui.command.innerHTML="Select fractal you like",this.selected=null},processWorkerMessage:function(a){var b,c;if("hd"!=a.data.fractalId)a.data.entropy<=evo.settings.entropyLimit?evo.generateFractal(a.data.fractalId):(evo.entropy[a.data.fractalId]=a.data.entropy,b=evo.canvas[a.data.fractalId].getContext("2d"),c=b.createImageData(evo.canvas[a.data.fractalId].width,evo.canvas[a.data.fractalId].height),c.data.set(a.data.imageData),b.putImageData(c,0,0),evo.generated++,evo.ui.updateCounter(),9==evo.generated&&($("#"+evo.selected).parent().removeClass("locked"),evo.hideSelect(),evo.lock=!1,evo.generated=0));else{var d=document.createElement("canvas");d.width=a.data.width,d.height=a.data.height,b=d.getContext("2d"),c=b.createImageData(d.width,d.height),c.data.set(a.data.imageData),b.putImageData(c,0,0),evo.ui.popupWindow.location.href=d.toDataURL("image/png")}}};window.onload=function(){evo.checkRequirements()&&evo.init()},window.addEventListener("resize",function(){screen.width===window.innerWidth&&evo.ui.isFullScreen()}),Storage.prototype.setObject=function(a,b){this.setItem(a,JSON.stringify(b))},Storage.prototype.getObject=function(a){var b=this.getItem(a);return b&&JSON.parse(b)},evo.save=function(){localStorage.setObject("settings",jQuery.extend(!0,{},evo.settings)),evo.ui.load.removeClass("hide")},evo.load=function(){if(!evo.lock&&(evo.lock=!0,this.checkSave())){evo.settings=localStorage.getObject("settings"),evo.hideSelect();for(var a=0;a<9;a++)evo.drawChromosone(a);evo.ui.update()}},evo.checkSave=function(){return localStorage.getObject("settings")},evo.settings={chromosone:[],structure:{iterationMax:{method:"random",distribution:"uniform",type:"integer",chance:.45,limit:{mandelbroot_quadratic:{min:100,max:3e3},mandelbroot_cubic:{min:100,max:500},julia_quadratic:{min:100,max:3e3},glynn_all:{min:100,max:500}},include:function(){return!0}},zoom:{method:"step",intensity:1,type:"float",chance:.6,limit:{mandelbroot_quadratic:{min:1,max:100},mandelbroot_cubic:{min:1,max:100},julia_quadratic:{min:1,max:10},glynn_all:{min:1,max:20}},include:function(){return!0}},moveX:{method:"step",intensity:1,type:"float",chance:.6,limit:{mandelbroot_quadratic:{min:-.75,max:.75},mandelbroot_cubic:{min:-.5,max:.5},julia_quadratic:{min:-1,max:1},glynn_all:{min:-1,max:1}},include:function(){return!0}},moveY:{method:"step",intensity:1,type:"float",chance:.6,limit:{mandelbroot_quadratic:{min:-.75,max:.75},mandelbroot_cubic:{min:-1,max:1},julia_quadratic:{min:-1,max:1},glynn_all:{min:-1,max:1}},include:function(){return!0}},cRe:{method:"step",intensity:1,type:"float",chance:.6,limit:{julia_quadratic:{min:-1,max:1},glynn_all:{min:-.5,max:.5}},include:function(){return"glynn_all"===evo.settings.fractal||"julia_quadratic"===evo.settings.fractal}},cIm:{method:"step",intensity:1,type:"float",chance:.6,limit:{julia_quadratic:{min:0,max:1}},include:function(){return"julia_quadratic"===evo.settings.fractal}},exp:{method:"step",intensity:1,type:"float",chance:.6,limit:{glynn_all:{min:1,max:2}},include:function(){return"glynn_all"===evo.settings.fractal}},redStart:{method:"random",distribution:"uniform",type:"integer",chance:.45,limit:{mandelbroot_quadratic:{min:0,max:255},mandelbroot_cubic:{min:0,max:255},julia_quadratic:{min:0,max:255},glynn_all:{min:0,max:255}},include:function(){return"pallete"!==evo.settings.color}},greenStart:{method:"random",distribution:"uniform",type:"integer",chance:.45,limit:{mandelbroot_quadratic:{min:0,max:255},mandelbroot_cubic:{min:0,max:255},julia_quadratic:{min:0,max:255},glynn_all:{min:0,max:255}},include:function(){return"pallete"!==evo.settings.color}},blueStart:{method:"random",distribution:"uniform",type:"integer",chance:.45,limit:{mandelbroot_quadratic:{min:0,max:255},mandelbroot_cubic:{min:0,max:255},julia_quadratic:{min:0,max:255},glynn_all:{min:0,max:255}},include:function(){return"pallete"!==evo.settings.color}},redSpeed:{method:"random",distribution:"uniform",type:"integer",chance:.45,limit:{mandelbroot_quadratic:{min:-4,max:4},mandelbroot_cubic:{min:-4,max:4},julia_quadratic:{min:-4,max:4},glynn_all:{min:-4,max:4}},include:function(){return"pallete"!==evo.settings.color}},greenSpeed:{method:"random",distribution:"uniform",type:"integer",chance:.45,limit:{mandelbroot_quadratic:{min:-4,max:4},mandelbroot_cubic:{min:-4,max:4},julia_quadratic:{min:-4,max:4},glynn_all:{min:-4,max:4}},include:function(){return"pallete"!==evo.settings.color}},blueSpeed:{method:"random",distribution:"uniform",type:"integer",chance:.45,limit:{mandelbroot_quadratic:{min:-4,max:4},mandelbroot_cubic:{min:-4,max:4},julia_quadratic:{min:-4,max:4},glynn_all:{min:-4,max:4}},include:function(){return"pallete"!==evo.settings.color}},a:{type:"vec3",method:"random",distribution:"uniform",chance:.45,limit:{mandelbroot_quadratic:{min:0,max:1},mandelbroot_cubic:{min:0,max:1},julia_quadratic:{min:0,max:1},glynn_all:{min:0,max:1}},include:function(){return"pallete"===evo.settings.color}},b:{type:"vec3",method:"random",distribution:"uniform",chance:.45,limit:{mandelbroot_quadratic:{min:0,max:1},mandelbroot_cubic:{min:0,max:1},julia_quadratic:{min:0,max:1},glynn_all:{min:0,max:1}},include:function(){return"pallete"===evo.settings.color}},c:{type:"vec3",method:"random",distribution:"uniform",chance:.45,limit:{mandelbroot_quadratic:{min:0,max:1},mandelbroot_cubic:{min:0,max:1},julia_quadratic:{min:0,max:1},glynn_all:{min:0,max:1}},include:function(){return"pallete"===evo.settings.color}},d:{type:"vec3",method:"random",distribution:"uniform",chance:.45,limit:{mandelbroot_quadratic:{min:0,max:1},mandelbroot_cubic:{min:0,max:1},julia_quadratic:{min:0,max:1},glynn_all:{min:0,max:1}},include:function(){return"pallete"===evo.settings.color}}},entropyLimit:7,fractal:"mandelbroot_quadratic",color:"simple",debugMode:!0,iteration:0},evo.ui={iterationSpan:null,command:null,details:null,settings:null,load:null,custom:null,popupWindow:null,customForm:null,init:function(){this.iterationSpan=document.getElementById("iteration"),this.command=document.getElementById("command"),this.details=$("#details"),this.settings=$("#settingsDialog"),this.load=$("#load"),this.custom=$("#saveCustomDialog"),this.customForm=$("#saveCustom"),this.update()},update:function(){evo.settings.debugMode?$(".debug[class=hide]").removeClass("hide"):$(".debug[class!=hide]").addColor("hide"),evo.checkSave()||this.load.addClass("hide"),evo.ui.updateIterator()},openSettings:function(){evo.lock?alert("Please wait until fractals are generated"):($("#color[name=color][value="+evo.settings.color+"]").prop("checked",!0),$("#fractal[name=color][value="+evo.settings.fractal+"]").prop("checked",!0),$("#debug_mode").prop("checked",evo.settings.debugMode),this.settings.modal("show"))},saveSettings:function(){var a=$("input[name=color]:checked","#settingsDialog").val(),b=$("input[name=fractal]:checked","#settingsDialog").val(),c=!1;a!=evo.settings.color&&(evo.settings.color=a,c=!0),b!=evo.settings.fractal&&(evo.settings.fractal=b,c=!0),evo.settings.debugMode=$("#debug_mode").is(":checked"),evo.settings.debugMode&&this.update(),c&&evo.generateNew()},openCustom:function(){evo.lock?alert("Please wait until fractals are generated"):this.custom.modal("show")},updateCounter:function(){this.command.innerHTML="Generating "+evo.generated+"/9"},updateIterator:function(){this.iterationSpan.innerHTML=evo.settings.iteration},resetIteration:function(){evo.settings.iteration=1,this.iterationSpan.innerHTML=evo.settings.iteration},isFullScreen:function(){$(".fullscreen").css("display","none")},saveImage:function(a,b){this.popupWindow=window.open("waiting.html","_blank"),evo.drawChromosone(evo.selected,a,b,!0)},saveCustom:function(){this.popupWindow=window.open("waiting.html","_blank");var a={};a.fractalId="hd",a.iterationMax=parseInt(this.customForm.find("input[name=iterations]").val()),a.zoom=parseFloat(this.customForm.find("input[name=zoom]").val()),a.moveX=parseFloat(this.customForm.find("input[name=x]").val()),a.moveY=parseFloat(this.customForm.find("input[name=y]").val()),a.cRe=parseFloat(this.customForm.find("input[name=cRe]").val()),a.cIm=parseFloat(this.customForm.find("input[name=cIm]").val()),a.exp=parseFloat(this.customForm.find("input[name=exp]").val()),a.redStart=parseInt(this.customForm.find("input[name=redStart]").val()),a.greenStart=parseInt(this.customForm.find("input[name=greenStart]").val()),a.blueStart=parseInt(this.customForm.find("input[name=blueStart]").val()),a.redSpeed=parseInt(this.customForm.find("input[name=redSpeed]").val()),a.greenSpeed=parseInt(this.customForm.find("input[name=greenSpeed]").val()),a.blueSpeed=parseInt(this.customForm.find("input[name=blueSpeed]").val()),a.width=parseInt(this.customForm.find("input[name=width]").val()),a.height=parseInt(this.customForm.find("input[name=height]").val()),a.fractal=this.customForm.find("input[name=fractal]:checked").val(),a.color=this.customForm.find("input[name=color]:checked").val(),a.start=new Vec3(a.redStart,a.greenStart,a.blueStart),a.speed=new Vec3(a.redSpeed,a.greenSpeed,a.blueSpeed),evo.drawCustomChromosone(a)}};