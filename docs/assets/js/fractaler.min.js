/*! fracgen 2017-11-30 */

function Chromosone(){if(arguments.length<1&&arguments.length>1)throw new SyntaxError("Chromosone invalid arguments","chromosone.js");if(void 0===arguments[0])throw new TypeError("Chromosone undefined input","chromosone.js");if("Settings"===arguments[0].constructor.name){var a=arguments[0];this.iterationMax=generateValue(null,a.structure.iterationMax,a.fractal),a.noZoom?(this.zoom=1,this.moveX=a.structure.moveX.limit[a.fractal].center,this.moveY=a.structure.moveY.limit[a.fractal].center):(this.zoom=generateValue(null,a.structure.zoom,a.fractal),this.moveX=generateValue(null,a.structure.moveX,a.fractal),this.moveY=generateValue(null,a.structure.moveY,a.fractal)),"glynn_all"!==a.fractal&&"julia_quadratic"!==a.fractal||(this.cRe=generateValue(null,a.structure.cRe,a.fractal),"julia_quadratic"===a.fractal?this.cIm=generateValue(null,a.structure.cIm,a.fractal):this.exp=generateValue(null,a.structure.exp,a.fractal)),"pallete"===a.color?(this.a=generateValue(null,a.structure.a,a.fractal),this.b=generateValue(null,a.structure.b,a.fractal),this.c=generateValue(null,a.structure.c,a.fractal),this.d=generateValue(null,a.structure.d,a.fractal)):(this.redStart=generateValue(null,a.structure.redStart,a.fractal),this.greenStart=generateValue(null,a.structure.greenStart,a.fractal),this.blueStart=generateValue(null,a.structure.blueStart,a.fractal),this.redSpeed=generateValue(null,a.structure.redSpeed,a.fractal),this.greenSpeed=generateValue(null,a.structure.greenSpeed,a.fractal),this.blueSpeed=generateValue(null,a.structure.blueSpeed,a.fractal))}else{var b=arguments[0];this.iterationMax=b.iterationMax,this.zoom=b.zoom,this.moveX=b.moveX,this.moveY=b.moveY,void 0!==b.cRe&&(this.cRe=b.cRe),void 0!==b.cIm&&(this.cIm=b.cIm),void 0!==b.exp&&(this.exp=b.exp),void 0===b.a?(this.redStart=b.redStart,this.greenStart=b.greenStart,this.blueStart=b.blueStart,this.redSpeed=b.redSpeed,this.greenSpeed=b.greenSpeed,this.blueSpeed=b.blueSpeed):(this.a=new Vec3(b.a),this.b=new Vec3(b.b),this.c=new Vec3(b.c),this.d=new Vec3(b.d))}}function generateValue(a,b,c){if("vec3"===b.type)return new Vec3;var d=0,e=b.limit[c].min,f=Math.abs(b.limit[c].min)+Math.abs(b.limit[c].max),g=e+f;if("random"===b.method||null===a)d="random"===b.method&&"exp"===b.distribution?randomExp(e,g):random(e,g);else do{d=a+Math.random()*f*random(-b.intensity,b.intensity)}while(d<b.limit[c].min||d>b.limit[c].max);return"integer"===b.type&&(d=Math.round(d)),d}function equalChromosones(a,b,c){if(a.iterationMax!==b.iterationMax||a.zoom!==b.zoom||a.moveX!==b.moveX||a.moveY!==b.moveY)return!1;if("julia_quadratic"===c.fractal){if(a.cRe!==b.cRe||a.cIm!==b.cIm)return!1}else if("glynn_all"===c.fractal&&(a.cRe!==b.cRe||a.exp!==b.exp))return!1;return!!("pallete"!==c.color||a.a.equals(b.a)&&a.b.equals(b.b)&&a.c.equals(b.c)&&a.d.equals(b.d))&&(a.redStart===b.redStart&&a.greenStart===b.greenStart&&a.blueStart===b.blueStart&&a.redSpeed===b.redSpeed&&a.greenSpeed===b.greenSpeed&&a.blueSpeed===b.blueSpeed)}function random(a,b){return Math.random()*(b-a)+a}function randomExp(a,b){return Math.pow(Math.random(),2)*(b-a)+a}function Rect(){var a=0,b=0,c=0,d=0;4===arguments.length?(a=arguments[0],b=arguments[1],c=arguments[2],d=arguments[3]):2===arguments.length&&(a=arguments[0].x,b=arguments[0].y,c=arguments[1].x,d=arguments[1].y),this.x=a,this.y=b,this.width=c,this.height=d}function Vec2(){var a=0,b=0;if(2===arguments.length)a=arguments[0],b=arguments[1];else if(1===arguments.length){var c=arguments[0];void 0!==c&&(a=c.x,b=c.y)}this.x=a,this.y=b}function Vec3(){var a=0,b=0,c=0;if(3===arguments.length)a=arguments[0],b=arguments[1],c=arguments[2];else if(1===arguments.length){var d=arguments[0];void 0!==d&&(a=d.x,b=d.y,c=d.z)}else a=Math.random(),b=Math.random(),c=Math.random();this.x=a,this.y=b,this.z=c}function pallete(a,b,c,d,e){if("number"!=typeof a&&"object"!=typeof b&&"object"!=typeof c&&"object"!=typeof d&&"object"!=typeof e)throw new TypeError("pallete wrong arguments","vector.js");return new Vec3(d).mul(a).add(e).mul(2*Math.PI).cos().mul(c).add(b).toRGB()}function createPixel(a){return[a.x,a.y,a.z,a.x+a.y+a.z]}function createPallete(a,b,c,d,e,f,g,h){var i=[];if("pallete"===a)for(var j=1/b,k=0,l=0;l<b;l++)i[l]=createPixel(pallete(k,e,f,g,h)),k+=j;else for(var m=0;m<b;m++)"simple"===a?(c.x+d.x<255&&c.x+d.x>0&&(c.x+=d.x),c.y+d.y<255&&c.y+d.y>0&&(c.y+=d.y),c.z+d.z<255&&c.z+d.z>0&&(c.z+=d.z)):"modulo"===a&&c.add(d).mod(255),i[m]=createPixel(c);return i}function drawMandelbroot(a,b,c,d,e,f,g,h,i,j,k,l,m){for(var n,o=0,p=createPallete(c,e,h,i,j,k,l,m),q=0,r=0,s=0;s<d.y;s++)for(var t=0;t<d.x;t++){var u,v=1.5*(t-d.x/2)/(.5*f*d.x)+g.x,w=(s-d.y/2)/(.5*f*d.y)+g.y,x=0,y=0,z=0;if("quadratic"===b)for(;x*x+y*y<=4&&z<e;)u=x*x-y*y+v,y=2*x*y+w,x=u,z++;else if("cubic"===b)for(;x*x+y*y<=4&&z<e;)u=x*x*x-3*x*(y*y)+v,y=3*x*x*y-y*y*y+w,x=u,z++;n=z<e?p[z]:p[e-1],a[o]=n[0],o++,a[o]=n[1],o++,a[o]=n[2],o++,a[o]=255,o++,n[3]!==r&&(q+=r),r=n[3]}return q/(d.x*d.y)}function drawJulia(a,b,c,d,e,f,g,h,i,j,k,l,m,n){for(var o,p,q,r,s,t,u=0,v=createPallete(b,d,i,j,k,l,m,n),w=0,x=0,y=0;y<c.y;y++)for(var z=0;z<c.x;z++){for(o=1.5*(z-c.x/2)/(.5*e*c.x)+f.x,p=(y-c.y/2)/(.5*e*c.y)+f.y,s=0;s<d&&o*o+p*p<4;s++)q=o,r=p,o=q*q-r*r+g,p=2*q*r+h;t=s<d?v[s]:v[d-1],a[u]=t[0],u++,a[u]=t[1],u++,a[u]=t[2],u++,a[u]=255,u++,t[3]!==x&&(w+=x),x=t[3]}return w/(c.x*c.y)}function drawGlynn(a,b,c,d,e,f,g,h,i,j,k,l,m,n){for(var o,p,q,r,s,t,u=0,v=createPallete(b,d,i,j,k,l,m,n),w=0,x=0,y=0;y<c.y;y++)for(var z=0;z<c.x;z++){for(o=1.5*(z-c.x/2)/(.5*e*c.x)+f.x,p=(y-c.y/2)/(.5*e*c.y)+f.y,s=0;s<d&&o*o+p*p<4;s++)r=Math.atan2(p,o),q=Math.sqrt(o*o+p*p),o=Math.pow(q,h)*Math.cos(h*r)+g,p=Math.pow(q,h)*Math.sin(h*r);t=s<d?v[s]:v[d-1],a[u]=t[0],u++,a[u]=t[1],u++,a[u]=t[2],u++,a[u]=255,u++,t[3]!==x&&(w+=x),x=t[3]}return w/(c.x*c.y)}Chromosone.prototype.mutate=function(a){var b=a.structure;Math.random()<=b.iterationMax.chance&&(this.iterationMax=generateValue(this.iterationMax,b.iterationMax,a.fractal)),a.noZoom||(Math.random()<=b.zoom.chance&&(this.zoom=generateValue(this.zoom,b.zoom,a.fractal)),Math.random()<=b.moveX.chance&&(this.moveX=generateValue(this.moveX,b.moveX,a.fractal)),Math.random()<=b.moveY.chance&&(this.moveY=generateValue(this.moveY,b.moveY,a.fractal))),"glynn_all"!==a.fractal&&"julia_quadratic"!==a.fractal||(Math.random()<=b.cRe.chance&&(this.cRe=generateValue(this.cRe,b.cRe,a.fractal)),"julia_quadratic"===a.fractal?Math.random()<=b.cIm.chance&&(this.cIm=generateValue(this.cIm,b.cIm,a.fractal)):Math.random()<=b.exp.chance&&(this.exp=generateValue(this.exp,b.exp,a.fractal))),"pallete"===a.color?(Math.random()<=b.a.chance&&(this.a=new Vec3),Math.random()<=b.b.chance&&(this.b=new Vec3),Math.random()<=b.c.chance&&(this.c=new Vec3),Math.random()<=b.d.chance&&(this.d=new Vec3)):(Math.random()<=b.redStart.chance&&(this.redStart=generateValue(this.redStart,b.redStart,a.fractal)),Math.random()<=b.greenStart.chance&&(this.greenStart=generateValue(this.greenStart,b.greenStart,a.fractal)),Math.random()<=b.blueStart.chance&&(this.blueStart=generateValue(this.blueStart,b.blueStart,a.fractal)),Math.random()<=b.redSpeed.chance&&(this.redSpeed=generateValue(this.redSpeed,b.redSpeed,a.fractal)),Math.random()<=b.greenSpeed.chance&&(this.greenSpeed=generateValue(this.greenSpeed,b.greenSpeed,a.fractal)),Math.random()<=b.blueSpeed.chance&&(this.blueSpeed=generateValue(this.blueSpeed,b.blueSpeed,a.fractal)))},Vec3.prototype.sin=function(){return this.x=Math.sin(this.x),this.y=Math.sin(this.y),this.z=Math.sin(this.z),this},Vec3.prototype.cos=function(){return this.x=Math.cos(this.x),this.y=Math.cos(this.y),this.z=Math.cos(this.z),this},Vec3.prototype.add=function(a){return"number"==typeof a?(this.x+=a,this.y+=a,this.z+=a):(this.x+=a.x,this.y+=a.y,this.z+=a.z),this},Vec3.prototype.sub=function(a){return"number"==typeof a?(this.x+=-a,this.y+=-a,this.z+=-a):(this.x+=-a.x,this.y+=-a.y,this.z+=-a.z),this},Vec3.prototype.mul=function(a){return"number"==typeof a?(this.x*=a,this.y*=a,this.z*=a):(this.x*=a.x,this.y*=a.y,this.z*=a.z),this},Vec3.prototype.mod=function(a){return"number"==typeof a?(this.x%=a,this.y%=a,this.z%=a):(this.x%=a.x,this.y%=a.y,this.z%=a.z),this},Vec3.prototype.toRGB=function(){return this.x=Math.round(255*this.x),this.y=Math.round(255*this.y),this.z=Math.round(255*this.z),this},Vec3.prototype.equals=function(a){return"object"==typeof a&&(this===a||this.x===a.x&&this.y===a.y&&this.z===a.z)},onmessage=function(a){var b,c=new Uint8ClampedArray(a.data.resolution.x*a.data.resolution.y*4),d=a.data.fractal.split("_"),e="preview"===a.data.fractalId?.9:a.data.zoom,f=void 0===a.data.limit?new Vec2(a.data.moveX,a.data.moveY):a.data.limit;"mandelbroot"===d[0]?b=drawMandelbroot(c,d[1],a.data.color,a.data.resolution,a.data.iterationMax,e,f,new Vec3(a.data.start),new Vec3(a.data.speed),new Vec3(a.data.a),new Vec3(a.data.b),new Vec3(a.data.c),new Vec3(a.data.d)):"julia"===d[0]?b=drawJulia(c,a.data.color,a.data.resolution,a.data.iterationMax,e,f,a.data.cRe,a.data.cIm,new Vec3(a.data.start),new Vec3(a.data.speed),new Vec3(a.data.a),new Vec3(a.data.b),new Vec3(a.data.c),new Vec3(a.data.d)):"glynn"===d[0]&&(b=drawGlynn(c,a.data.color,a.data.resolution,a.data.iterationMax,e,f,a.data.cRe,a.data.exp,new Vec3(a.data.start),new Vec3(a.data.speed),new Vec3(a.data.a),new Vec3(a.data.b),new Vec3(a.data.c),new Vec3(a.data.d))),postMessage({fractalId:a.data.fractalId,imageData:c,entropy:b,resolution:a.data.resolution,move:new Vec2(a.data.moveX,a.data.moveY),zoom:a.data.zoom,loading:a.data.loading})};