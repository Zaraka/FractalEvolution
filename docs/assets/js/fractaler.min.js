/*! fracgen 2017-07-23 */

function Chromosone(){if(1!==arguments.length)throw new SyntaxError("Chromosone invalid arguments","chromosone.js");if(void 0===arguments[0])throw new TypeError("Chromosone undefined input","chromosone.js");if("Chromosone"===arguments[0].constructor.name){var a=arguments[0];this.iterationMax=a.iterationMax,this.zoom=a.zoom,this.moveX=a.moveX,this.moveY=a.moveY,void 0!==a.cRe&&(this.cRe=a.cRe),void 0!==a.cIm&&(this.cIm=a.cIm),void 0!==a.exp&&(this.exp=a.exp),void 0===a.a?(this.redStart=a.redStart,this.greenStart=a.greenStart,this.blueStart=a.blueStart,this.redSpeed=a.redSpeed,this.greenSpeed=a.greenSpeed,this.blueSpeed=a.blueSpeed):(this.a=new Vec3(a.a),this.b=new Vec3(a.b),this.c=new Vec3(a.c),this.d=new Vec3(a.d))}else{var b=arguments[0];this.iterationMax=generateValue(null,b.structure.iterationMax,b.fractal),this.zoom=generateValue(null,b.structure.zoom,b.fractal),this.moveX=generateValue(null,b.structure.moveX,b.fractal),this.moveY=generateValue(null,b.structure.moveY,b.fractal),"glynn_all"!==b.fractal&&"julia_quadratic"!==b.fractal||(this.cRe=generateValue(null,b.structure.cRe,b.fractal),"julia_quadratic"===b.fractal?this.cIm=generateValue(null,b.structure.cIm,b.fractal):this.exp=generateValue(null,b.structure.exp,b.fractal)),"pallete"===b.color?(this.a=generateValue(null,b.structure.a,b.fractal),this.b=generateValue(null,b.structure.b,b.fractal),this.c=generateValue(null,b.structure.c,b.fractal),this.d=generateValue(null,b.structure.d,b.fractal)):(this.redStart=generateValue(null,b.structure.redStart,b.fractal),this.greenStart=generateValue(null,b.structure.greenStart,b.fractal),this.blueStart=generateValue(null,b.structure.blueStart,b.fractal),this.redSpeed=generateValue(null,b.structure.redSpeed,b.fractal),this.greenSpeed=generateValue(null,b.structure.greenSpeed,b.fractal),this.blueSpeed=generateValue(null,b.structure.blueSpeed,b.fractal))}}function generateValue(a,b,c){if("vec3"===b.type)return new Vec3;var d=0,e=b.limit[c].min,f=Math.abs(b.limit[c].min)+Math.abs(b.limit[c].max),g=e+f;if("random"===b.method||null===a)d="random"===b.method&&"exp"===b.distribution?randomExp(e,g):random(e,g);else do{d=a+Math.random()*f*random(-b.intensity,b.intensity)}while(d<b.limit[c].min||d>b.limit[c].max);return"integer"===b.type&&(d=Math.round(d)),d}function equalChromosones(a,b,c){if(a.iterationMax!==b.iterationMax||a.zoom!==b.zoom||a.moveX!==b.moveX||a.moveY!==b.moveY)return!1;if("julia_quadratic"===c.fractal){if(a.cRe!==b.cRe||a.cIm!==b.cIm)return!1}else if("glynn_all"===c.fractal&&(a.cRe!==b.cRe||a.exp!==b.exp))return!1;return!!("pallete"!==c.color||a.a.equals(b.a)&&a.b.equals(b.b)&&a.c.equals(b.c)&&a.d.equals(b.d))&&(a.redStart===b.redStart&&a.greenStart===b.greenStart&&a.blueStart===b.blueStart&&a.redSpeed===b.redSpeed&&a.greenSpeed===b.greenSpeed&&a.blueSpeed===b.blueSpeed)}function random(a,b){return Math.random()*(b-a)+a}function randomExp(a,b){return Math.pow(Math.random(),2)*(b-a)+a}function Vec3(){var a=0,b=0,c=0;if(3==arguments.length)a=arguments[0],b=arguments[1],c=arguments[2];else if(1==arguments.length){var d=arguments[0];void 0!==d&&(a=d.x,b=d.y,c=d.z)}else a=Math.random(),b=Math.random(),c=Math.random();this.x=a,this.y=b,this.z=c}function pallete(a,b,c,d,e){if("number"!=typeof a&&"object"!=typeof b&&"object"!=typeof c&&"object"!=typeof d&&"object"!=typeof e)throw new TypeError("pallete wrong arguments","vector.js");return new Vec3(d).mul(a).add(e).mul(2*Math.PI).cos().mul(c).add(b).toRGB()}function createPixel(a){return[a.x,a.y,a.z,a.x+a.y+a.z]}function createPallete(a,b,c,d,e,f,g,h){var i=[];if("pallete"===a)for(var j=1/b,k=0,l=0;l<b;l++)i[l]=createPixel(pallete(k,e,f,g,h)),k+=j;else for(var m=0;m<b;m++)"simple"==a?(c.x+d.x<255&&c.x+d.x>0&&(c.x+=d.x),c.y+d.y<255&&c.y+d.y>0&&(c.y+=d.y),c.z+d.z<255&&c.z+d.z>0&&(c.z+=d.z)):"modulo"==a&&c.add(d).mod(255),i[m]=createPixel(c);return i}function drawMandelbroot(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){for(var p,q=0,r=createPallete(c,f,j,k,l,m,n,o),s=0,t=0,u=0;u<e;u++)for(var v=0;v<d;v++){var w,x=1.5*(v-d/2)/(.5*g*d)+h,y=(u-e/2)/(.5*g*e)+i,z=0,A=0,B=0;if("quadratic"==b)for(;z*z+A*A<=2&&B<f;)w=z*z-A*A+x,A=2*z*A+y,z=w,B++;else if("cubic"==b)for(;z*z+A*A<=2&&B<f;)w=z*z*z-3*z*(A*A)+x,A=3*z*z*A-A*A*A+y,z=w,B++;p=B<f?r[B]:r[f-1],a[q]=p[0],q++,a[q]=p[1],q++,a[q]=p[2],q++,a[q]=255,q++,p[3]!==t&&(s+=t),t=p[3]}return s/(d*e)}function drawJulia(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){for(var q,r,s,t,u,v,w=0,x=createPallete(b,e,k,l,m,n,o,p),y=0,z=0,A=0;A<d;A++)for(var B=0;B<c;B++){for(q=1.5*(B-c/2)/(.5*f*c)+g,r=(A-d/2)/(.5*f*d)+h,u=0;u<e&&q*q+r*r<4;u++)s=q,t=r,q=s*s-t*t+i,r=2*s*t+j;v=u<e?x[u]:x[e-1],a[w]=v[0],w++,a[w]=v[1],w++,a[w]=v[2],w++,a[w]=255,w++,v[3]!==z&&(y+=z),z=v[3]}return y/(c*d)}function drawGlynn(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){for(var q,r,s,t,u,v,w=0,x=createPallete(b,e,k,l,m,n,o,p),y=0,z=0,A=0;A<d;A++)for(var B=0;B<c;B++){for(q=1.5*(B-c/2)/(.5*f*c)+g,r=(A-d/2)/(.5*f*d)+h,u=0;u<e&&q*q+r*r<4;u++)t=Math.atan2(r,q),s=Math.sqrt(q*q+r*r),q=Math.pow(s,j)*Math.cos(j*t)+i,r=Math.pow(s,j)*Math.sin(j*t);v=u<e?x[u]:x[e-1],a[w]=v[0],w++,a[w]=v[1],w++,a[w]=v[2],w++,a[w]=255,w++,v[3]!==z&&(y+=z),z=v[3]}return y/(c*d)}Chromosone.prototype.mutate=function(a){var b=a.structure;Math.random()<=b.iterationMax.chance&&(this.iterationMax=generateValue(this.iterationMax,b.iterationMax,a.fractal)),Math.random()<=b.zoom.chance&&(this.zoom=generateValue(this.zoom,b.zoom,a.fractal)),Math.random()<=b.moveX.chance&&(this.moveX=generateValue(this.moveX,b.moveX,a.fractal)),Math.random()<=b.moveY.chance&&(this.moveY=generateValue(this.moveY,b.moveY,a.fractal)),"glynn_all"!==a.fractal&&"julia_quadratic"!==a.fractal||(Math.random()<=b.cRe.chance&&(this.cRe=generateValue(this.cRe,b.cRe,a.fractal)),"julia_quadratic"===a.fractal?Math.random()<=b.cIm.chance&&(this.cIm=generateValue(this.cIm,b.cIm,a.fractal)):Math.random()<=b.exp.chance&&(this.exp=generateValue(this.exp,b.exp,a.fractal))),"pallete"===a.color?(Math.random()<=b.a.chance&&(this.a=new Vec3),Math.random()<=b.b.chance&&(this.b=new Vec3),Math.random()<=b.c.chance&&(this.c=new Vec3),Math.random()<=b.d.chance&&(this.d=new Vec3)):(Math.random()<=b.redStart.chance&&(this.redStart=generateValue(this.redStart,b.redStart,a.fractal)),Math.random()<=b.greenStart.chance&&(this.greenStart=generateValue(this.greenStart,b.greenStart,a.fractal)),Math.random()<=b.blueStart.chance&&(this.blueStart=generateValue(this.blueStart,b.blueStart,a.fractal)),Math.random()<=b.redSpeed.chance&&(this.redSpeed=generateValue(this.redSpeed,b.redSpeed,a.fractal)),Math.random()<=b.greenSpeed.chance&&(this.greenSpeed=generateValue(this.greenSpeed,b.greenSpeed,a.fractal)),Math.random()<=b.blueSpeed.chance&&(this.blueSpeed=generateValue(this.blueSpeed,b.blueSpeed,a.fractal)))},Vec3.prototype.sin=function(){return this.x=Math.sin(this.x),this.y=Math.sin(this.y),this.z=Math.sin(this.z),this},Vec3.prototype.cos=function(){return this.x=Math.cos(this.x),this.y=Math.cos(this.y),this.z=Math.cos(this.z),this},Vec3.prototype.add=function(a){return"number"==typeof a?(this.x+=a,this.y+=a,this.z+=a):(this.x+=a.x,this.y+=a.y,this.z+=a.z),this},Vec3.prototype.sub=function(a){return"number"==typeof a?(this.x+=-a,this.y+=-a,this.z+=-a):(this.x+=-a.x,this.y+=-a.y,this.z+=-a.z),this},Vec3.prototype.mul=function(a){return"number"==typeof a?(this.x*=a,this.y*=a,this.z*=a):(this.x*=a.x,this.y*=a.y,this.z*=a.z),this},Vec3.prototype.mod=function(a){return"number"==typeof a?(this.x%=a,this.y%=a,this.z%=a):(this.x%=a.x,this.y%=a.y,this.z%=a.z),this},Vec3.prototype.toRGB=function(){return this.x=Math.round(255*this.x),this.y=Math.round(255*this.y),this.z=Math.round(255*this.z),this},Vec3.prototype.equals=function(a){return"object"==typeof a&&(this===a||this.x==a.x&&this.y==a.y&&this.z==a.z)},onmessage=function(a){var b,c=new Uint8ClampedArray(a.data.width*a.data.height*4),d=a.data.fractal.split("_");"mandelbroot"===d[0]?b=drawMandelbroot(c,d[1],a.data.color,a.data.width,a.data.height,a.data.iterationMax,a.data.zoom,a.data.moveX,a.data.moveY,new Vec3(a.data.start),new Vec3(a.data.speed),new Vec3(a.data.a),new Vec3(a.data.b),new Vec3(a.data.c),new Vec3(a.data.d)):"julia"===d[0]?b=drawJulia(c,a.data.color,a.data.width,a.data.height,a.data.iterationMax,a.data.zoom,a.data.moveX,a.data.moveY,a.data.cRe,a.data.cIm,new Vec3(a.data.start),new Vec3(a.data.speed),new Vec3(a.data.a),new Vec3(a.data.b),new Vec3(a.data.c),new Vec3(a.data.d)):"glynn"===d[0]&&(b=drawGlynn(c,a.data.color,a.data.width,a.data.height,a.data.iterationMax,a.data.zoom,a.data.moveX,a.data.moveY,a.data.cRe,a.data.exp,new Vec3(a.data.start),new Vec3(a.data.speed),new Vec3(a.data.a),new Vec3(a.data.b),new Vec3(a.data.c),new Vec3(a.data.d))),postMessage({fractalId:a.data.fractalId,imageData:c,entropy:b,width:a.data.width,height:a.data.height})};